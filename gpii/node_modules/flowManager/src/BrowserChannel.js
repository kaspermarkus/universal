(function () {

    "use strict";

    var fluid = require("infusion");
    var gpii = fluid.registerNamespace("gpii");

    fluid.registerNamespace("gpii.request.flowManager");

    fluid.defaults("gpii.flowManager.browserChannel", {
        gradeNames: ["fluid.standardRelayComponent", "autoInit"]
    });

    fluid.defaults("kettle.requests.request.handler.browserChannel", {
        gradeNames: ["gpii.request.flowManager.sessionAware", "autoInit"],
        invokers: {
            handle: {
                funcName: "gpii.request.flowManager.browserChannelHandle",
                args: ["{request}"],
                dynamic: true
            }
        }
    });

    gpii.request.flowManager.browserChannelHandle = function (fluidRequest) {
        var data = fluidRequest.data;

        var initialSettings = gpii.settingsHandlers.WebSocketsSettingsHandler.getCurrentSettingsById(data);
        fluidRequest.socket.emit("connectionSucceeded", initialSettings);
        gpii.settingsHandlers.WebSocketsSettingsHandler.addBrowser(data, fluidRequest.socket);

        fluidRequest.socket.on("disconnect", function () {
            gpii.settingsHandlers.WebSocketsSettingsHandler.removeBrowser(fluidRequest.socket);
        });
    };

})();
