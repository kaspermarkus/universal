/*
 * GPII Launch Handlers
 *
 * Copyright 2017 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = fluid || require("infusion"),
    gpii = fluid.registerNamespace("gpii");

fluid.registerNamespace("gpii.launchHandlers");
fluid.registerNamespace("gpii.launchHandlers.flexibleHandler");


gpii.launchHandlers.flexibleHandler.set = function (payload) {
    return fluid.transform(payload, function (allSettingsBlocks, solutionId) {
        return fluid.transform(allSettingsBlocks, function (handlerData) {
            // find desire state { running: X }
            var desiredState = handlerData.settings.running;
            if (desiredState !== true && desiredState !== false) {
                fluid.fail("Unable to set the launch state of ", solutionId, " to ", desiredState);
            }

            // get current state
            var currentState = gpii.launchHandlers.flexibleHandler.executeGetBlock(handlerData.options, solutionId);

            // if not in desired state
            if  (currentState !== desiredState) {
                desiredState === true ?
                    gpii.launchHandlers.flexibleHandler.executeSetBlock(handlerData, "setTrue") :
                    gpii.launchHandlers.flexibleHandler.executeSetBlock(handlerData, "setFalse");
            }

            return gpii.settingsHandlers.setSettings(handlerData, { running: currentState });
        });
    });
};

gpii.launchHandlers.flexibleHandler.get = function (payload) {
    return fluid.transform(payload, function (allSettingsBlocks, solutionId) {
        return fluid.transform(allSettingsBlocks, function (handlerData) {
            var currentState = gpii.launchHandlers.flexibleHandler.executeGetBlock(handlerData.options, solutionId);
            return { settings: { running: currentState }};
        });
    });
};

gpii.launchHandlers.flexibleHandler.executeSetBlock = function (mainEntry, blockName) {
    var setBlocks = fluid.get(mainEntry, [ "options", blockName ]);
    fluid.each(fluid.makeArray(setBlocks), function (setBlock) {
        fluid.invokeGradedFunction(setBlock.type, setBlock);
    });
};

gpii.launchHandlers.flexibleHandler.executeGetBlock = function (options) {
    return gpii.processReporter.handleIsRunning({ isRunning: options.getState });
};
